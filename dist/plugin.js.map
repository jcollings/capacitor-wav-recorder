{"version":3,"file":"plugin.js","sources":["esm/index.js","esm/web.js"],"sourcesContent":["import { registerPlugin } from '@capacitor/core';\r\nconst WAVRecorder = registerPlugin('WAVRecorder', {\r\n    web: () => import('./web').then(m => new m.WAVRecorderWeb()),\r\n});\r\nexport * from './definitions';\r\nexport { WAVRecorder };\r\n//# sourceMappingURL=index.js.map","import { WebPlugin } from '@capacitor/core';\r\nimport { Filesystem, Directory, Encoding } from '@capacitor/filesystem';\r\nexport class WAVRecorderWeb extends WebPlugin {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.bytes_per_sample = 1;\r\n        this.number_of_channels = 1;\r\n        this.sample_rate = 8000;\r\n        this.buffer_size = 1024;\r\n        this.base_path = \"dictations\";\r\n        this.recorded = [];\r\n        this.recording = -1;\r\n        this.current_file = '';\r\n    }\r\n    async checkPermissions() {\r\n        throw this.unimplemented('Not implemented on web.');\r\n    }\r\n    async requestPermissions() {\r\n        try {\r\n            await navigator.mediaDevices.getUserMedia({ audio: true, video: false });\r\n            return { microphone: 'granted' };\r\n        }\r\n        catch (e) {\r\n            return { microphone: 'denied' };\r\n        }\r\n    }\r\n    async init(settings) {\r\n        if (settings.sampleRate) {\r\n            this.sample_rate = settings.sampleRate;\r\n        }\r\n        return { value: true };\r\n    }\r\n    async startRecord(settings) {\r\n        console.log(settings);\r\n        this.current_file = this.base_path + \"/\" + settings.path;\r\n        try {\r\n            await Filesystem.deleteFile({ path: this.current_file, directory: Directory.Data });\r\n        }\r\n        catch (e) {\r\n        }\r\n        this.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });\r\n        var AudioContext = window.AudioContext;\r\n        this.context = new AudioContext();\r\n        const input = this.context.createMediaStreamSource(this.stream);\r\n        // https://stackoverflow.com/questions/65447236/scriptnode-onaudioprocess-is-deprecated-any-alternative\r\n        const processor = this.context.createScriptProcessor(this.buffer_size, this.number_of_channels);\r\n        processor.onaudioprocess = async (audioProcessingEvent) => {\r\n            if (this.recording === -1) {\r\n                return;\r\n            }\r\n            var channels = [];\r\n            for (var i = 0; i < this.number_of_channels; i++) {\r\n                channels.push(audioProcessingEvent.inputBuffer.getChannelData(i));\r\n            }\r\n            const audio_data = this._encode(this._interleave(channels));\r\n            this.recorded.push(audio_data);\r\n            const data = this._multiUint8ArrayToString(this.recorded);\r\n            this.notifyListeners('recordingBuffer', audio_data);\r\n            await Filesystem.writeFile({\r\n                path: this.current_file,\r\n                data: data,\r\n                directory: Directory.Data,\r\n                encoding: Encoding.UTF16,\r\n                recursive: true,\r\n            });\r\n            if (this.recording === 0) {\r\n                this.recording = -1;\r\n            }\r\n        };\r\n        input.connect(processor);\r\n        processor.connect(this.context.destination);\r\n        this.recording = 1;\r\n        // this.recorder?.start();\r\n        return { value: true };\r\n    }\r\n    async stopRecord() {\r\n        var _a;\r\n        // this.recording = 0;\r\n        // this.recorder?.stop();\r\n        (_a = this.stream) === null || _a === void 0 ? void 0 : _a.getTracks()[0].stop();\r\n        return { value: true };\r\n    }\r\n    _encode(buffer) {\r\n        var length = buffer.length;\r\n        var data = new Uint8Array(length * this.bytes_per_sample);\r\n        for (var i = 0; i < length; i++) {\r\n            var index = i * this.bytes_per_sample;\r\n            var sample = buffer[i];\r\n            // clip sample 1/-1\r\n            if (sample > 1) {\r\n                sample = 1;\r\n            }\r\n            else if (sample < -1) {\r\n                sample = -1;\r\n            }\r\n            /**\r\n             * Once a signal is digitized it is treated as a number (as you quite rightly point out)\r\n             * and for 16bits the range of numbers are -32768 to +32767. The numbers are created by\r\n             * an analogue to digital converter.\r\n             **/\r\n            // bit reduce and convert to uInt\r\n            switch (this.bytes_per_sample) {\r\n                case 4:\r\n                    sample = sample * 2147483648;\r\n                    data[index] = sample;\r\n                    data[index + 1] = sample >> 8;\r\n                    data[index + 2] = sample >> 16;\r\n                    data[index + 3] = sample >> 24;\r\n                    break;\r\n                case 3:\r\n                    sample = sample * 8388608;\r\n                    data[index] = sample;\r\n                    data[index + 1] = sample >> 8;\r\n                    data[index + 2] = sample >> 16;\r\n                    break;\r\n                case 2:\r\n                    sample = sample * 32768;\r\n                    data[index] = sample;\r\n                    data[index + 1] = sample >> 8;\r\n                    break;\r\n                case 1:\r\n                    data[index] = (sample + 1) * 128;\r\n                    break;\r\n                default:\r\n                    throw 'Only 8, 16, 24 and 32 bits per sample are supported';\r\n            }\r\n        }\r\n        return data;\r\n    }\r\n    _interleave(buffers) {\r\n        var channels = buffers.length;\r\n        var result = new Float32Array(buffers[0].length);\r\n        for (var i = 0; i < buffers[0].length; i++) {\r\n            for (var channel = 0; channel < channels; channel++) {\r\n                result[i * channels + channel] = buffers[channel][i];\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n    _multiUint8ArrayToString(bufferArray) {\r\n        var binary = \"\";\r\n        for (var i = 0; i < bufferArray.length; i++) {\r\n            var bytes = bufferArray[i];\r\n            var len = bytes.byteLength;\r\n            for (var j = 0; j < len; j++) {\r\n                binary += String.fromCharCode(bytes[j]);\r\n            }\r\n        }\r\n        return binary;\r\n    }\r\n}\r\n//# sourceMappingURL=web.js.map"],"names":["registerPlugin","WebPlugin","Filesystem","Directory","Encoding"],"mappings":"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"}